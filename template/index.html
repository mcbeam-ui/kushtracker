<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Cannabis Stock Tracker</title>
<style>
body {
background: linear-gradient(135deg, #1a5928 0%, #4caf50 100%);
font-family: Arial, sans-serif;
color: white;
padding: 20px;
margin: 0;
min-height: 100vh;
}
.container {
max-width: 1200px;
margin: 0 auto;
}
h1 {
text-align: center;
font-size: 2.5em;
margin-bottom: 30px;
}
.status-bar {
background: rgba(0,0,0,0.3);
padding: 20px;
border-radius: 10px;
margin-bottom: 30px;
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
gap: 15px;
}
.btn {
background: #66bb6a;
color: white;
border: none;
padding: 12px 25px;
border-radius: 8px;
cursor: pointer;
font-size: 16px;
font-weight: bold;
}
.btn:hover {
background: #81c784;
}
.grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 20px;
margin-bottom: 30px;
}
.card {
background: rgba(0,0,0,0.3);
padding: 20px;
border-radius: 10px;
border: 2px solid #66bb6a;
}
.card h3 {
margin-top: 0;
color: #e8f5e9;
}
.loading {
text-align: center;
padding: 50px;
font-size: 1.2em;
}
</style>
</head>
<body>
<div class="container">
<h1>ğŸŒ¿ Cannabis Stock Tracker ğŸŒ¿</h1>

<div class="status-bar">
<div>
<strong>Last Check:</strong> 
<span id="lastCheck">Loading...</span>
</div>
<div>
<strong>Dispensaries:</strong> 8
</div>
<button class="btn" onclick="refreshNow()">ğŸ”„ Refresh</button>
</div>

<div id="grid" class="grid">
<div class="loading">Loading dispensaries...</div>
</div>

<div class="card">
<h3>ğŸ“Š Recent Changes</h3>
<div id="changes">
<p>No changes detected yet</p>
</div>
</div>
</div>

<script>
let refreshing = false;

function formatDate(iso) {
if (!iso) return 'Never';
const date = new Date(iso);
const now = new Date();
const diff = Math.floor((now - date) / 1000);
if (diff < 60) return 'Just now';
if (diff < 3600) return Math.floor(diff / 60) + ' min ago';
return date.toLocaleString();
}

function update() {
fetch('/api/status')
.then(r => r.json())
.then(data => {
document.getElementById('lastCheck').textContent = formatDate(data.last_check);

const sites = Object.values(data.websites);
const grid = document.getElementById('grid');

if (sites.length === 0) {
grid.innerHTML = '<div class="loading">Performing initial check...</div>';
return;
}

grid.innerHTML = sites.map(site => 
'<div class="card">' +
'<h3>ğŸƒ ' + site.name + '</h3>' +
'<p><strong>Products:</strong> ' + (site.product_count || 0) + '</p>' +
'<p><strong>Status:</strong> ' + (site.status === 'ok' ? 'âœ“ Active' : 'âœ— Error') + '</p>' +
'<p style="font-size:0.9em;color:#c8e6c9;">' + formatDate(site.last_checked) + '</p>' +
'</div>'
).join('');

const changesDiv = document.getElementById('changes');
if (data.recent_changes && data.recent_changes.length > 0) {
changesDiv.innerHTML = data.recent_changes.slice(0, 5).map(c =>
'<p><strong>' + c.name + ':</strong> ' + c.changes.join(', ') + '</p>'
).join('');
} else {
changesDiv.innerHTML = '<p>No changes detected yet</p>';
}
})
.catch(err => {
console.error('Error:', err);
document.getElementById('grid').innerHTML = '<div class="loading">Error loading data</div>';
});
}

function refreshNow() {
if (refreshing) return;
refreshing = true;
const btn = document.querySelector('.btn');
btn.textContent = 'â³ Refreshing...';
btn.disabled = true;

fetch('/api/refresh')
.then(() => {
setTimeout(() => {
update();
btn.textContent = 'ğŸ”„ Refresh';
btn.disabled = false;
refreshing = false;
}, 3000);
});
}

update();
setInterval(update, 30000);
</script>
</body>
</html>
